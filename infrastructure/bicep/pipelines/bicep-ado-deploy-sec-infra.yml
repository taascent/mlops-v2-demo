variables:
  - name: BASTION_PW
    value: $(bastionpw)

  - ${{ if eq(variables['Build.SourceBranchName'], 'main') }}:
      # 'main' branch: PRD environment
      - template: ../../config-infra-prod.yml
  - ${{ if ne(variables['Build.SourceBranchName'], 'main') }}:  
      # 'develop' or feature branches: DEV environment
      - template: ../../config-infra-dev.yml

trigger:
- none

pr:
- main
- dev

pool:
  vmImage: $(ap_vm_image)


stages :
  - stage: Lint
    displayName: Lint and Preflight check
    jobs:
    - job: LintBicep
      displayName: Lint Bicep Code
      steps:
        - checkout: self
        - script: |
            az bicep build --file ./infrastructure/mainsec.bicep
          name: LintBicepCode
          displayName: Run Bicep Linter

  - stage: PreflightValidation
    jobs:
    - job: ValidateBicepCode
      displayName: Validate Bicep Code
      steps:
        - task: AzureCli@2
          name: RunPreflightValidateion
          displayName: Run Preflight Validation
          inputs:
            azureSubscription: $(ado_service_connection_rg)
            scriptType: 'bash'
            scriptLocation: 'inlineScript'
            inlineScript: |
              az deployment sub validate \
                --name $(Build.DefinitionName) \
                --template-file ./infrastructure/mainsec.bicep \
                --location $(location) \
                --parameters location=$(location) nameSpace=$(namespace) dsvmJumpboxUsername=tdadmin dsvmJumpboxPassword=$(BASTION_PW)


  - stage: CheckOutBicepAndDeploy
    displayName: Deploy AML Workspace
    jobs:
    - deployment: DeployBicep
      displayName: deploy to $(environment)
      pool:
        vmImage: $(ap_vm_image)
      environment: $(environment)
      strategy:
        runOnce:
          deploy:
            steps:
            - checkout: self
            - task: AzureCLI@2
              displayName: Running Dev Deployment
              inputs:
                azureSubscription: $(ado_service_connection_rg)
                scriptType: bash
                scriptLocation: inlineScript
                inlineScript: |
                  az --version
                  echo "deploying bicep..."
                  az deployment sub create \
                    --name $(Build.DefinitionName) \
                    --location $(location) \
                    --template-file ./infrastructure/mainsec.bicep \
                    --parameters location=$(location) location=$(location) nameSpace=$(namespace) dsvmJumpboxUsername=tdadmin dsvmJumpboxPassword=$(BASTION_PW)
